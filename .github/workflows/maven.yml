# Workflow to reproduce "Verifying URN" step using BitcoinJ Digest Enforcer Rules
name: Maven Digest URN Verification

on:
  workflow_dispatch:

jobs:
  build-with-digest-verification:
    runs-on: ubuntu-latest
    
    steps:
    - name: Harden Runner
      uses: step-security/harden-runner@v2.11.1
      with:
        egress-policy: audit # Start with audit to see network calls
        
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 11
      uses: actions/setup-java@v4
      with:
        java-version: '11'
        distribution: 'temurin'
        
    - name: Create Maven project structure
      run: |
        mkdir -p src/main/java/com/example
        mkdir -p src/test/java/com/example
        
        # Create a simple Java class
        cat > src/main/java/com/example/App.java << 'EOF'
        package com.example;
        
        import org.apache.commons.lang3.StringUtils;
        import org.slf4j.Logger;
        import org.slf4j.LoggerFactory;
        
        public class App {
            private static final Logger logger = LoggerFactory.getLogger(App.class);
            
            public static void main(String[] args) {
                logger.info("Hello World: {}", StringUtils.capitalize("hello"));
            }
        }
        EOF
        
        # Create a test class
        cat > src/test/java/com/example/AppTest.java << 'EOF'
        package com.example;
        
        import org.junit.jupiter.api.Test;
        import static org.junit.jupiter.api.Assertions.*;
        
        public class AppTest {
            @Test
            public void testApp() {
                assertTrue(true);
            }
        }
        EOF
        
    - name: Create pom.xml with BitcoinJ Digest Enforcer Rules
      run: |
        cat > pom.xml << 'EOF'
        <?xml version="1.0" encoding="UTF-8"?>
        <project xmlns="http://maven.apache.org/POM/4.0.0"
                 xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                 xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 
                 http://maven.apache.org/xsd/maven-4.0.0.xsd">
            <modelVersion>4.0.0</modelVersion>
            
            <groupId>com.example</groupId>
            <artifactId>digest-verification-test</artifactId>
            <version>1.0-SNAPSHOT</version>
            <packaging>jar</packaging>
            
            <properties>
                <maven.compiler.source>11</maven.compiler.source>
                <maven.compiler.target>11</maven.compiler.target>
                <project.build.sourceEncoding>UTF-8</project.build.sourceEncoding>
            </properties>
            
            <dependencies>
                <!-- Dependencies that will trigger URN verification -->
                <dependency>
                    <groupId>org.apache.commons</groupId>
                    <artifactId>commons-lang3</artifactId>
                    <version>3.12.0</version>
                </dependency>
                
                <dependency>
                    <groupId>org.slf4j</groupId>
                    <artifactId>slf4j-api</artifactId>
                    <version>2.0.7</version>
                </dependency>
                
                <dependency>
                    <groupId>ch.qos.logback</groupId>
                    <artifactId>logback-classic</artifactId>
                    <version>1.4.8</version>
                </dependency>
                
                <dependency>
                    <groupId>org.junit.jupiter</groupId>
                    <artifactId>junit-jupiter</artifactId>
                    <version>5.9.3</version>
                    <scope>test</scope>
                </dependency>
            </dependencies>
            
            <repositories>
                <!-- Add repository for BitcoinJ Digest Enforcer Rules -->
                <repository>
                    <id>central</id>
                    <name>Maven Central</name>
                    <url>https://repo1.maven.org/maven2</url>
                </repository>
            </repositories>
            
            <pluginRepositories>
                <pluginRepository>
                    <id>central</id>
                    <name>Maven Central</name>
                    <url>https://repo1.maven.org/maven2</url>
                </pluginRepository>
            </pluginRepositories>
            
            <build>
                <plugins>
                    <plugin>
                        <groupId>org.apache.maven.plugins</groupId>
                        <artifactId>maven-compiler-plugin</artifactId>
                        <version>3.11.0</version>
                    </plugin>
                    
                    <plugin>
                        <groupId>org.apache.maven.plugins</groupId>
                        <artifactId>maven-surefire-plugin</artifactId>
                        <version>3.1.2</version>
                    </plugin>
                    
                    <!-- BitcoinJ Digest Enforcer Rules - This produces "Verifying URN" messages -->
                    <plugin>
                        <groupId>org.apache.maven.plugins</groupId>
                        <artifactId>maven-enforcer-plugin</artifactId>
                        <version>3.4.1</version>
                        <dependencies>
                            <dependency>
                                <groupId>uk.co.froot.maven.enforcer</groupId>
                                <artifactId>digest-enforcer-rules</artifactId>
                                <version>0.0.1</version>
                            </dependency>
                        </dependencies>
                        <executions>
                            <execution>
                                <id>enforce-digest-verification</id>
                                <phase>verify</phase>
                                <goals>
                                    <goal>enforce</goal>
                                </goals>
                                <configuration>
                                    <rules>
                                        <!-- This is the rule that prints "Verifying URN" -->
                                        <digestRule implementation="uk.co.froot.maven.enforcer.DigestRule">
                                            <!-- Enable snapshot mode to see URN generation -->
                                            <buildSnapshot>true</buildSnapshot>
                                            
                                            <!-- URNs in format: groupId:artifactId:version:type:classifier:scope:hash -->
                                            <urns>
                                                <!-- These will be verified and cause "Verifying URN" messages -->
                                                <urn>org.apache.commons:commons-lang3:3.12.0:jar:null:compile:d919d904486c0c66c1e9d2ade7bb69e0bfd86aff</urn>
                                                <urn>org.slf4j:slf4j-api:2.0.7:jar:null:compile:41eb7184ea9d556f6c4cd0b65b6b945f07a76d6b</urn>
                                                <urn>ch.qos.logback:logback-classic:1.4.8:jar:null:compile:4b8c7c2c9a8c38e6f5ec5b6b7b7e6d9b8c7d6e5f</urn>
                                            </urns>
                                        </digestRule>
                                        
                                        <!-- Additional standard enforcer rules -->
                                        <requireMavenVersion>
                                            <version>[3.6.0,)</version>
                                        </requireMavenVersion>
                                        <requireJavaVersion>
                                            <version>[11,)</version>
                                        </requireJavaVersion>
                                    </rules>
                                </configuration>
                            </execution>
                        </executions>
                    </plugin>
                </plugins>
            </build>
        </project>
        EOF
        
            
    - name: Build with Maven and capture URN verification
      run: |
        echo "Starting Maven build with BitcoinJ Digest Enforcer Rules..."
        echo "This should produce 'Verifying URN' messages during the verify phase"
        
        # Run Maven with maximum verbosity to capture all URN verification messages
        mvn clean verify -X -e \
          -Dmaven.wagon.http.connectionTimeout=10000 \
          -Dmaven.wagon.http.readTimeout=30000 \
          2>&1 | tee maven-build.log
          
    - name: Search for URN verification messages
      run: |
        echo "=== Searching for URN-related messages ==="
        echo "Looking for the exact 'Verifying URN' messages..."
        
        # Search for URN verification messages (the main target)
        if grep -i "verifying.*urn\|urn.*verif" maven-build.log; then
            echo "✅ FOUND: 'Verifying URN' messages detected!"
        else
            echo "❌ No 'Verifying URN' messages found"
        fi
        
        echo ""
        echo "=== All URN-related messages ==="
        grep -n -i "urn" maven-build.log || echo "No URN messages found"
        
        echo ""
        echo "=== Digest Enforcer Rule execution ==="
        grep -n -i "digest.*rule\|digestrule\|enforce.*digest" maven-build.log || echo "No digest rule messages found"
        
        echo ""
        echo "=== Maven Enforcer Plugin execution ==="
        grep -n -A5 -B5 "maven-enforcer-plugin" maven-build.log || echo "No enforcer plugin execution found"
        
        echo ""
        echo "=== Network-related delays during verification ==="
        grep -n -i "downloading\|connect\|timeout\|slow" maven-build.log | head -20 || echo "No network messages found"
        
    - name: Analyze timing and performance
      run: |
        echo "=== Performance Analysis ==="
        
        # Extract timing information from Maven output
        echo "--- Build phase timing ---"
        grep -E "\[INFO\].*\.\.\. [0-9]+\.[0-9]+s|\[INFO\] BUILD SUCCESS" maven-build.log || echo "No timing info found"
        
        echo ""
        echo "--- Dependency resolution timing ---"
        grep -E "Downloaded|Downloading" maven-build.log | head -10 || echo "No download timing found"
        
        echo ""
        echo "--- Enforcer plugin timing ---"
        grep -A10 -B10 "enforce.*goal" maven-build.log || echo "No enforcer timing found"
        
    - name: Test with different Harden Runner modes
      run: |
        echo "=== Testing impact of network policies ==="
        echo "This simulates the difference between having Harden Runner vs not having it"
        
        # Test with different Maven timeout settings to simulate network policy delays
        echo "--- Quick build (simulating no network policies) ---"
        time mvn clean compile -q \
          -Dmaven.wagon.http.connectionTimeout=60000 \
          -Dmaven.wagon.http.readTimeout=120000
          
        echo ""
        echo "--- Slow build (simulating network policy delays) ---"
        time mvn clean verify -q \
          -Dmaven.wagon.http.connectionTimeout=5000 \
          -Dmaven.wagon.http.readTimeout=10000 \
          2>&1 | tee slow-build.log
          
        # Check if the slow build shows different URN verification behavior
        echo ""
        echo "--- URN messages in slow build ---"
        grep -i "urn\|timeout\|retry" slow-build.log || echo "No URN or timeout messages in slow build"
        
    - name: Upload build logs and analysis
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: digest-verification-logs
        path: |
          maven-build.log
          slow-build.log
          pom.xml
